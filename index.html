<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>STORES お店タイプ診断</title>
  <script defer src="https://cdn.jsdelivr.net/npm/face-api.js"></script>
  <style>
    body { font-family: sans-serif; text-align: center; padding: 20px; }
    .question, .result { display: none; }
    .visible { display: block; }
    video, canvas { width: 240px; height: 180px; border-radius: 8px; }
    .btn { padding: 10px 20px; margin: 10px; cursor: pointer; }
  </style>
</head>
<body>
  <h1>STORES お店タイプ診断</h1>
  <p>いくつかの質問と表情から、あなたの「お店タイプ」を診断します！</p>

  <div id="qna" class="visible">
    <div>
      <p>1. 休日の過ごし方は？</p>
      <label><input type="radio" name="q1" value="0" /> カフェでゆったり</label><br />
      <label><input type="radio" name="q1" value="1" /> スポーツで汗をかく</label><br />
      <label><input type="radio" name="q1" value="2" /> 雑貨屋さん巡り</label>
    </div>
    <div>
      <p>2. 自分を一言で？</p>
      <label><input type="radio" name="q2" value="0" /> 穏やか</label><br />
      <label><input type="radio" name="q2" value="1" /> 情熱的</label><br />
      <label><input type="radio" name="q2" value="2" /> センス派</label>
    </div>
    <div>
      <p>3. 好きな飲み物は？</p>
      <label><input type="radio" name="q3" value="0" /> コーヒー</label><br />
      <label><input type="radio" name="q3" value="1" /> プロテイン</label><br />
      <label><input type="radio" name="q3" value="2" /> ハーブティー</label>
    </div>
    <button class="btn" onclick="startCamera()">顔も使って診断する📷</button>
    <button class="btn" onclick="simpleDiagnosis()">顔なしで簡易診断🙆‍♀️</button>
  </div>

  <div id="camera" class="question">
    <p>表情を読み取っています… にっこり笑ってみてください！</p>
    <video id="video" autoplay muted></video><br />
    <button class="btn" onclick="analyzeExpression()">診断結果を見る</button>
  </div>

  <div id="result" class="result">
    <h2>あなたは…</h2>
    <canvas id="faceCanvas"></canvas>
    <h3 id="storeType"></h3>
    <p id="description"></p>
    <button class="btn" onclick="location.reload()">もう一度診断する</button>
  </div>

  <script>
    const storeTypes = {
      happy: ["カフェ店主 ☕", "明るくて居心地の良い空間をつくるのが得意！"],
      neutral: ["雑貨屋オーナー 🛍️", "落ち着きとセンスが光るお店タイプです。"],
      angry: ["ラーメン職人 🍜", "こだわりを大切にする情熱派タイプ！"]
    };

    let expressionType = "neutral";
    let stream;

    async function startCamera() {
      document.getElementById("qna").classList.remove("visible");
      document.getElementById("camera").classList.add("visible");
      await faceapi.nets.tinyFaceDetector.loadFromUri("https://cdn.jsdelivr.net/npm/face-api.js/models");
      await faceapi.nets.faceExpressionNet.loadFromUri("https://cdn.jsdelivr.net/npm/face-api.js/models");

      stream = await navigator.mediaDevices.getUserMedia({ video: true });
      const video = document.getElementById("video");
      video.srcObject = stream;
    }

    async function analyzeExpression() {
      const video = document.getElementById("video");
      const detection = await faceapi.detectSingleFace(video, new faceapi.TinyFaceDetectorOptions()).withFaceExpressions();

      if (!detection || !detection.expressions) {
        alert("顔が検出できませんでした！");
        return;
      }

      const expressions = detection.expressions;
      expressionType = Object.keys(expressions).reduce((a, b) => expressions[a] > expressions[b] ? a : b);
      stream.getTracks().forEach(track => track.stop());

      showResult();
    }

    function simpleDiagnosis() {
      expressionType = "neutral"; // デフォルト表情
      document.getElementById("qna").classList.remove("visible");
      showResult();
    }

    function getQuestionScore() {
      let total = 0;
      ["q1", "q2", "q3"].forEach(q => {
        const checked = document.querySelector(`input[name="${q}"]:checked`);
        if (checked) total += parseInt(checked.value);
      });
      return total;
    }

    function showResult() {
      const canvas = document.getElementById("faceCanvas");
      const ctx = canvas.getContext("2d");
      canvas.width = 240; canvas.height = 180;
      if (stream) {
        ctx.drawImage(document.getElementById("video"), 0, 0, canvas.width, canvas.height);
      } else {
        ctx.fillStyle = "#ccc";
        ctx.fillRect(0, 0, canvas.width, canvas.height);
        ctx.font = "20px sans-serif";
        ctx.fillStyle = "#000";
        ctx.fillText("キャラ画像", 60, 90);
      }

      const [title, desc] = storeTypes[expressionType] || storeTypes["neutral"];
      document.getElementById("storeType").textContent = title;
      document.getElementById("description").textContent = desc;
      document.getElementById("camera").classList.remove("visible");
      document.getElementById("result").classList.add("visible");
    }
  </script>
</body>
</html>
