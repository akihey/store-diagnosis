<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>STORES ãŠåº—ã‚¿ã‚¤ãƒ—è¨ºæ–­</title>
  <script defer src="https://cdn.jsdelivr.net/npm/face-api.js"></script>
  <style>
    body { font-family: sans-serif; text-align: center; padding: 20px; }
    .question, .result { display: none; }
    .visible { display: block; }
    video, canvas { width: 240px; height: 180px; border-radius: 8px; }
    .btn { padding: 10px 20px; margin: 10px; cursor: pointer; }
  </style>
</head>
<body>
  <h1>STORES ãŠåº—ã‚¿ã‚¤ãƒ—è¨ºæ–­</h1>
  <p>ã„ãã¤ã‹ã®è³ªå•ã¨è¡¨æƒ…ã‹ã‚‰ã€ã‚ãªãŸã®ã€ŒãŠåº—ã‚¿ã‚¤ãƒ—ã€ã‚’è¨ºæ–­ã—ã¾ã™ï¼</p>

  <div id="qna" class="visible">
    <div>
      <p>1. ä¼‘æ—¥ã®éã”ã—æ–¹ã¯ï¼Ÿ</p>
      <label><input type="radio" name="q1" value="0" /> ã‚«ãƒ•ã‚§ã§ã‚†ã£ãŸã‚Š</label><br />
      <label><input type="radio" name="q1" value="1" /> ã‚¹ãƒãƒ¼ãƒ„ã§æ±—ã‚’ã‹ã</label><br />
      <label><input type="radio" name="q1" value="2" /> é›‘è²¨å±‹ã•ã‚“å·¡ã‚Š</label>
    </div>
    <div>
      <p>2. è‡ªåˆ†ã‚’ä¸€è¨€ã§ï¼Ÿ</p>
      <label><input type="radio" name="q2" value="0" /> ç©ã‚„ã‹</label><br />
      <label><input type="radio" name="q2" value="1" /> æƒ…ç†±çš„</label><br />
      <label><input type="radio" name="q2" value="2" /> ã‚»ãƒ³ã‚¹æ´¾</label>
    </div>
    <div>
      <p>3. å¥½ããªé£²ã¿ç‰©ã¯ï¼Ÿ</p>
      <label><input type="radio" name="q3" value="0" /> ã‚³ãƒ¼ãƒ’ãƒ¼</label><br />
      <label><input type="radio" name="q3" value="1" /> ãƒ—ãƒ­ãƒ†ã‚¤ãƒ³</label><br />
      <label><input type="radio" name="q3" value="2" /> ãƒãƒ¼ãƒ–ãƒ†ã‚£ãƒ¼</label>
    </div>
    <button class="btn" onclick="startCamera()">é¡”ã‚‚ä½¿ã£ã¦è¨ºæ–­ã™ã‚‹ğŸ“·</button>
    <button class="btn" onclick="simpleDiagnosis()">é¡”ãªã—ã§ç°¡æ˜“è¨ºæ–­ğŸ™†â€â™€ï¸</button>
  </div>

  <div id="camera" class="question">
    <p>è¡¨æƒ…ã‚’èª­ã¿å–ã£ã¦ã„ã¾ã™â€¦ ã«ã£ã“ã‚Šç¬‘ã£ã¦ã¿ã¦ãã ã•ã„ï¼</p>
    <video id="video" autoplay muted></video><br />
    <button class="btn" onclick="analyzeExpression()">è¨ºæ–­çµæœã‚’è¦‹ã‚‹</button>
  </div>

  <div id="result" class="result">
    <h2>ã‚ãªãŸã¯â€¦</h2>
    <canvas id="faceCanvas"></canvas>
    <h3 id="storeType"></h3>
    <p id="description"></p>
    <button class="btn" onclick="location.reload()">ã‚‚ã†ä¸€åº¦è¨ºæ–­ã™ã‚‹</button>
  </div>

  <script>
    const storeTypes = {
      happy: ["ã‚«ãƒ•ã‚§åº—ä¸» â˜•", "æ˜ã‚‹ãã¦å±…å¿ƒåœ°ã®è‰¯ã„ç©ºé–“ã‚’ã¤ãã‚‹ã®ãŒå¾—æ„ï¼"],
      neutral: ["é›‘è²¨å±‹ã‚ªãƒ¼ãƒŠãƒ¼ ğŸ›ï¸", "è½ã¡ç€ãã¨ã‚»ãƒ³ã‚¹ãŒå…‰ã‚‹ãŠåº—ã‚¿ã‚¤ãƒ—ã§ã™ã€‚"],
      angry: ["ãƒ©ãƒ¼ãƒ¡ãƒ³è·äºº ğŸœ", "ã“ã ã‚ã‚Šã‚’å¤§åˆ‡ã«ã™ã‚‹æƒ…ç†±æ´¾ã‚¿ã‚¤ãƒ—ï¼"]
    };

    let expressionType = "neutral";
    let stream;

    async function startCamera() {
      document.getElementById("qna").classList.remove("visible");
      document.getElementById("camera").classList.add("visible");
      await faceapi.nets.tinyFaceDetector.loadFromUri("https://cdn.jsdelivr.net/npm/face-api.js/models");
      await faceapi.nets.faceExpressionNet.loadFromUri("https://cdn.jsdelivr.net/npm/face-api.js/models");

      stream = await navigator.mediaDevices.getUserMedia({ video: true });
      const video = document.getElementById("video");
      video.srcObject = stream;
    }

    async function analyzeExpression() {
      const video = document.getElementById("video");
      const detection = await faceapi.detectSingleFace(video, new faceapi.TinyFaceDetectorOptions()).withFaceExpressions();

      if (!detection || !detection.expressions) {
        alert("é¡”ãŒæ¤œå‡ºã§ãã¾ã›ã‚“ã§ã—ãŸï¼");
        return;
      }

      const expressions = detection.expressions;
      expressionType = Object.keys(expressions).reduce((a, b) => expressions[a] > expressions[b] ? a : b);
      stream.getTracks().forEach(track => track.stop());

      showResult();
    }

    function simpleDiagnosis() {
      expressionType = "neutral"; // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆè¡¨æƒ…
      document.getElementById("qna").classList.remove("visible");
      showResult();
    }

    function getQuestionScore() {
      let total = 0;
      ["q1", "q2", "q3"].forEach(q => {
        const checked = document.querySelector(`input[name="${q}"]:checked`);
        if (checked) total += parseInt(checked.value);
      });
      return total;
    }

    function showResult() {
      const canvas = document.getElementById("faceCanvas");
      const ctx = canvas.getContext("2d");
      canvas.width = 240; canvas.height = 180;
      if (stream) {
        ctx.drawImage(document.getElementById("video"), 0, 0, canvas.width, canvas.height);
      } else {
        ctx.fillStyle = "#ccc";
        ctx.fillRect(0, 0, canvas.width, canvas.height);
        ctx.font = "20px sans-serif";
        ctx.fillStyle = "#000";
        ctx.fillText("ã‚­ãƒ£ãƒ©ç”»åƒ", 60, 90);
      }

      const [title, desc] = storeTypes[expressionType] || storeTypes["neutral"];
      document.getElementById("storeType").textContent = title;
      document.getElementById("description").textContent = desc;
      document.getElementById("camera").classList.remove("visible");
      document.getElementById("result").classList.add("visible");
    }
  </script>
</body>
</html>
